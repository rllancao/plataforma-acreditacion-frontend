<div class="flex min-h-screen flex-col bg-gray-50 p-4 sm:p-6 lg:p-8">
  <!-- Encabezado -->
  <header class="mb-8 flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center">
    <div class="flex items-center">
      <app-volver-atras></app-volver-atras>
      <h1 class="ml-4 text-3xl font-bold text-gray-800">Base de Datos de Trabajadores</h1>
    </div>

    <!-- Gráfico de Dona -->
    <div class="h-64 w-full max-w-md rounded-lg bg-white p-4 shadow-sm">
      <canvas #donutChart></canvas>
    </div>
  </header>

  <!-- Cuerpo Principal (Tabla y Filtros) -->
  <main class="flex-1 rounded-lg bg-white p-6 shadow-sm">
    <div class="flex flex-col justify-between gap-4 md:flex-row">
      <h2 class="text-xl font-semibold text-gray-700">Todos los Postulantes</h2>
    </div>

    <!-- SECCIÓN DE FILTROS -->
    <form [formGroup]="filterForm" class="mt-4 grid grid-cols-1 gap-4 rounded-lg border border-gray-200 p-4 md:grid-cols-2 lg:grid-cols-6">
      <!-- Filtro por Empresa -->
      <div class="w-full">
        <label for="empresa" class="block text-sm font-medium text-gray-700">Empresa</label>
        <select formControlName="empresa" id="empresa" class="mt-1 block w-full rounded-lg border border-gray-300 py-2 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
          <option value="">Todas</option>
          <option *ngFor="let empresa of empresas" [value]="empresa">{{ empresa }}</option>
        </select>
      </div>
      <!-- Filtro por Faena -->
      <div class="w-full">
        <label for="faena" class="block text-sm font-medium text-gray-700">Faena</label>
        <!-- ✅ CORRECCIÓN: Se itera sobre 'faenasDisponibles' -->
        <select formControlName="faena" id="faena" class="mt-1 block w-full rounded-lg border border-gray-300 py-2 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
          <option value="">Todas</option>
          <option *ngFor="let faena of faenasDisponibles" [value]="faena">{{ faena }}</option>
        </select>
      </div>
      <!-- Filtro por Cargo -->
      <div class="w-full">
        <label for="cargo" class="block text-sm font-medium text-gray-700">Cargo</label>
        <!-- ✅ CORRECCIÓN: Se itera sobre 'cargosDisponibles' -->
        <select formControlName="cargo" id="cargo" class="mt-1 block w-full rounded-lg border border-gray-300 py-2 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
          <option value="">Todos</option>
          <option *ngFor="let cargo of cargosDisponibles" [value]="cargo">{{ cargo }}</option>
        </select>
      </div>
      <!-- Filtro por RUT -->
      <div class="w-full">
        <label for="rut" class="block text-sm font-medium text-gray-700">RUT / Pasaporte</label>
        <input formControlName="rut" type="text" id="rut" class="mt-1 block h-10 w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="  12345678-9">
      </div>
      <!-- Filtro por Nombre -->
      <div class="w-full">
        <label for="nombre" class="block text-sm font-medium text-gray-700">Nombre</label>
        <input formControlName="nombre" type="text" id="nombre" class="mt-1 block h-10 w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="  Juan Pérez">
      </div>
      <!-- Filtro por Estado -->
      <div class="w-full">
        <label for="estado" class="block text-sm font-medium text-gray-700">Estado</label>
        <select formControlName="estado" id="estado" class="mt-1 block w-full rounded-lg border border-gray-300 py-2 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
          <option value="">Todos</option>
          <option value="Aprobado">Aprobado</option>
          <option value="Pendiente">Pendiente</option>
          <option value="Rechazado">Rechazado</option>
        </select>
      </div>
      <!-- Botón Limpiar -->
      <div class="flex items-end">
        <button (click)="resetFilters()" type="button" class="flex w-full items-center justify-center gap-2 rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">
          <lucide-icon [img]="XCircle" class="h-4 w-4"></lucide-icon>
          Limpiar
        </button>
      </div>
    </form>

    <!-- Tabla de Trabajadores -->
    <div class="mt-6 overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200 bg-[#E2E9EF]">
        <thead class="bg-[#CC2D3B]">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-white">Nombre</th>
          <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-white">RUT</th>
          <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-white">Cargo</th>
          <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-white">Empresa</th>
          <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-white">Faena</th>
          <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-white">Estado</th>
          <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-white">Observación</th>
          <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-white">Acciones</th>
        </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 bg-[#f2f8fc]">
        <tr *ngFor="let worker of filteredWorkers">
          <td class="whitespace-nowrap px-6 py-4 text-sm font-medium text-gray-900">{{ worker.nombre }}</td>
          <td class="whitespace-nowrap px-6 py-4 text-sm text-black">{{ worker.rut_pasaporte }}</td>
          <td class="whitespace-nowrap px-6 py-4 text-sm text-black">{{ worker.cargo }}</td>
          <td class="whitespace-nowrap px-6 py-4 text-sm text-black">{{ worker.faenaRelacion.usuario.nombre || 'N/A' }}</td>
          <td class="whitespace-nowrap px-6 py-4 text-sm text-black">{{ worker.faenaRelacion.nombre || 'N/A' }}</td>
          <td class="whitespace-nowrap px-6 py-4 text-sm">
              <span class="rounded-full px-2 py-1 text-xs font-semibold" [ngClass]="{
                'bg-green-100 text-green-800': worker.status === 'Aprobado',
                'bg-yellow-100 text-yellow-800': worker.status === 'Pendiente',
                'bg-red-100 text-red-800': worker.status === 'Rechazado'
              }">
                {{ worker.status || 'No definido' }}
              </span>
          </td>
          <td class="whitespace-nowrap px-6 py-4 text-sm">
            <button *ngIf="(worker.documentosVencidos && worker.documentosVencidos.length > 0) || (worker.documentosPorVencer && worker.documentosPorVencer.length > 0)"
                    (click)="openWarningModal(worker)"
                    class="rounded-md bg-white px-3 py-1.5 text-xs animate-pulse font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
            >
              <lucide-icon [img]="Eye" class="inline-block h-4 w-4 mr-1"></lucide-icon>
              Ver
            </button>
            <span *ngIf="!(worker.documentosVencidos && worker.documentosVencidos.length > 0) && !(worker.documentosPorVencer && worker.documentosPorVencer.length > 0)">
                Sin Observaciones
              </span>
          </td>
          <td class="whitespace-nowrap px-6 py-4 text-sm font-medium">
            <a [routerLink]="['/trabajador', worker.id]" class="rounded-md bg-white px-3 py-1.5 text-xs font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
              Detalles
            </a>
          </td>
        </tr>
        <tr *ngIf="filteredWorkers.length === 0">
          <td colspan="8" class="text-center py-8 text-gray-500">No se encontraron postulantes con los filtros aplicados.</td>
        </tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- POPUP MODAL PARA OBSERVACIONES -->
  <div *ngIf="isModalOpen" class="fixed inset-0 z-50 flex items-center justify-center">
    <div (click)="closeWarningModal()" class="absolute inset-0 bg-black opacity-50"></div>
    <div class="relative z-10 w-full max-w-lg rounded-lg bg-white p-6 shadow-xl">
      <div class="flex items-start justify-between">
        <div>
          <h3 class="text-lg font-semibold leading-6 text-gray-900">Observaciones de Documentos</h3>
          <p class="mt-1 text-sm text-gray-500">Para el trabajador: {{ workerForModal?.nombre }}</p>
        </div>
        <button (click)="closeWarningModal()" class="text-gray-400 hover:text-gray-600">
          <lucide-icon [img]="X" class="h-6 w-6"></lucide-icon>
        </button>
      </div>
      <div class="mt-4 space-y-4">
        <div *ngIf="workerForModal?.documentosVencidos?.length > 0">
          <h4 class="font-medium text-red-700">Vencidos</h4>
          <ul class="mt-2 list-disc list-inside space-y-1 text-sm text-gray-600">
            <li *ngFor="let doc of workerForModal.documentosVencidos">{{ doc.nombre }}</li>
          </ul>
        </div>
        <div *ngIf="workerForModal?.documentosPorVencer?.length > 0">
          <h4 class="font-medium text-yellow-700">Por Vencer (Próximos 30 días)</h4>
          <ul class="mt-2 list-disc list-inside space-y-1 text-sm text-gray-600">
            <li *ngFor="let doc of workerForModal.documentosPorVencer">{{ doc.nombre }}</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

