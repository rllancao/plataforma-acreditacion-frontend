<div class="flex min-h-screen flex-col bg-gray-50 p-4 sm:p-6 lg:p-8">
  <!-- Encabezado con información de la Faena -->
  <header class="mb-6 rounded-lg bg-white p-6 shadow-sm">
    <div class="flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center">
      <!-- Grupo de botones a la izquierda -->
      <div class="flex items-center gap-4">
        <!-- Botón para cambiar de Faena -->
        <a [routerLink]="['/select-faena']" class="flex items-center gap-2 rounded-lg bg-white px-4 py-2 text-xl font-bold text-gray-800 ring-1 ring-gray-200 transition hover:bg-gray-100 sm:text-2xl">
          <span>{{ selectedFaena?.nombre || 'Cargando faena...' }}</span>
          <lucide-icon [img]="ChevronDown" class="h-6 w-6"></lucide-icon>
        </a>

        <!-- Botón "Modificar Faena" -->
        @if ((userRole === 'admin' || userRole === 'superAdmin') && selectedFaena) {
          <a [routerLink]="['/admin/modificar-faena', selectedFaena.id]" class="flex items-center gap-2 rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-indigo-700">
            <lucide-icon [img]="Wrench" class="h-4 w-4"></lucide-icon>
            <span>Modificar Faena</span>
          </a>
        }
      </div>

      <!-- Información de la Empresa a la derecha -->
      <div class="text-right text-sm text-gray-600">
        <span class="font-semibold">Empresa a cargo:</span>
        <p>{{ selectedFaena?.usuario?.nombre }}</p>
      </div>
    </div>
  </header>

  <!-- SECCIÓN DE VISUALIZACIONES -->
  <section class="mb-6 grid grid-cols-1 gap-6 lg:grid-cols-3">
    <!-- Gráfico Principal de Estados -->
    <div class="rounded-lg bg-white p-4 shadow-sm lg:col-span-1">
      <h2 class="mb-4 w-full text-center text-xl font-semibold text-gray-700">Estado General</h2>
      <div class="mx-auto h-64 w-full max-w-sm">
        <canvas #donutChart></canvas>
      </div>
    </div>

    <!-- Gráficos de Completitud por Cargo -->
    <div class="rounded-lg bg-white p-6 shadow-sm lg:col-span-2">
      <h2 class="mb-4 border-b pb-2 text-xl font-semibold text-gray-700">Completitud de Cargos</h2>
      @if (cargoStats.length > 0) {
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3">
          <!-- Usamos @for para crear un gráfico por cada cargo -->
          @for (cargo of cargoStats; track cargo.chartId) {
            <div class="rounded-md border p-3 text-center">
              <h3 class="truncate text-sm font-semibold text-gray-600" [title]="cargo.nombre + ' (Tanda ' + cargo.tanda + ')'">
                {{ cargo.nombre }} <span class="font-normal text-gray-500">- Tanda {{ cargo.tanda }}</span>
              </h3>
              <div class="mx-auto mt-2 h-32 w-full">
                <canvas [id]="cargo.chartId"></canvas>
              </div>
            </div>
          }
        </div>
      } @else {
        <!-- Mensaje por si no hay cargos con vacantes -->
        <div class="flex h-full items-center justify-center py-10 text-center text-gray-500">
          <p>No hay cargos con vacantes asignadas en esta faena.</p>
        </div>
      }
    </div>
  </section>

  <!-- Cuerpo Principal (Tabla y Filtros) -->
  <main class="flex-1 rounded-lg bg-white p-6 shadow-sm">
    <div class="flex flex-col justify-between gap-4 md:flex-row">
      <h2 class="text-xl font-semibold text-gray-700">Postulantes</h2>
    </div>

    <!-- SECCIÓN DE FILTROS -->
    <form [formGroup]="filterForm" class="mt-4 grid grid-cols-1 gap-4 rounded-lg border border-gray-200 p-4 md:grid-cols-2 lg:grid-cols-5">
      <!-- Filtro por Cargo -->
      <div class="w-full">
        <label for="cargo" class="block text-sm font-medium text-gray-700">Cargo</label>
        <select formControlName="cargo" id="cargo" class="mt-1 block w-full rounded-lg border border-gray-300 py-2 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
          <option value="">Todos</option>
          @for (cargo of cargos; track cargo) {
            <option [value]="cargo">{{ cargo }}</option>
          }
        </select>
      </div>
      <!-- Filtro por RUT -->
      <div class="w-full">
        <label for="rut" class="block text-sm font-medium text-gray-700">RUT / Pasaporte</label>
        <input formControlName="rut" type="text" id="rut" class="mt-1 block w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="12345678-9">
      </div>
      <!-- Filtro por Nombre -->
      <div class="w-full">
        <label for="nombre" class="block text-sm font-medium text-gray-700">Nombre</label>
        <input formControlName="nombre" type="text" id="nombre" class="mt-1 block w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Juan Pérez">
      </div>
      <!-- Filtro por Estado -->
      <div class="w-full">
        <label for="estado" class="block text-sm font-medium text-gray-700">Estado</label>
        <select formControlName="estado" id="estado" class="mt-1 block w-full rounded-lg border border-gray-300 py-2 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
          <option value="">Todos</option>
          <option value="Aprobado">Aprobado</option>
          <option value="Pendiente">Pendiente</option>
          <option value="Rechazado">Rechazado</option>
        </select>
      </div>
      <!-- Botón Limpiar -->
      <div class="flex items-end">
        <button (click)="resetFilters()" type="button" class="flex w-full items-center justify-center gap-2 rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">
          <lucide-icon [img]="XCircle" class="h-4 w-4"></lucide-icon>
          Limpiar
        </button>
      </div>
    </form>

    <!-- Tabla de Trabajadores -->
    <div class="mt-6 overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200 bg-[#E2E9EF]">
        <thead class="bg-[#CC2D3B]">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-white">Cargo</th>
          <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-white">RUT</th>
          <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-white">Nombre</th>
          <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-white">Empresa</th>
          <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-white">Fecha Atención</th>
          <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-white">Estado</th>
          <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-white">Observación</th>
          <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-white">Acciones</th>
        </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 bg-[#f2f8fc]">
          @for (worker of filteredWorkers; track worker.id) {
            <tr>
              <!-- ✅ CORRECCIÓN APLICADA AQUÍ -->
              <td class="whitespace-nowrap px-6 py-4 text-sm text-black">
                {{ worker.cargo?.nombre }}
                @if(worker.cargo?.tanda > 1) {
                  <span class="text-xs text-gray-500">(Tanda {{ worker.cargo.tanda }})</span>
                }
              </td>
              <td class="whitespace-nowrap px-6 py-4 text-sm text-black">{{ worker.rut_pasaporte }}</td>
              <td class="whitespace-nowrap px-6 py-4 text-sm font-medium text-gray-900">{{ worker.nombre }}</td>
              <td class="whitespace-nowrap px-6 py-4 text-sm text-black">{{ selectedFaena?.usuario?.nombre }}</td>
              <td class="whitespace-nowrap px-6 py-4 text-sm text-black">{{ worker.fecha_atencion | date:'dd/MM/yyyy' }}</td>
              <td class="whitespace-nowrap px-6 py-4 text-sm">
                <span class="rounded-full px-2 py-1 text-xs font-semibold" [ngClass]="{
                  'bg-green-100 text-green-800': worker.status === 'Aprobado',
                  'bg-yellow-100 text-yellow-800': worker.status === 'Pendiente',
                  'bg-red-100 text-red-800': worker.status === 'Rechazado'
                }">
                  {{ worker.status || 'No definido' }}
                </span>
              </td>
              <td class="whitespace-nowrap px-6 py-4 text-sm">
                @if ((worker.documentosVencidos && worker.documentosVencidos.length > 0) || (worker.documentosPorVencer && worker.documentosPorVencer.length > 0)) {
                  <button
                    (click)="openWarningModal(worker)"
                    class="rounded-md bg-white px-3 py-1.5 text-xs font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
                  >
                    <lucide-icon [img]="Eye" class="inline-block h-4 w-4 mr-1"></lucide-icon>
                    Ver
                  </button>
                } @else {
                  Sin Observaciones
                }
              </td>
              <td class="whitespace-nowrap px-6 py-4 text-sm font-medium">
                <a [routerLink]="['/trabajador', worker.id]" class="rounded-md bg-white px-3 py-1.5 text-xs font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                  Detalles
                </a>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="8" class="py-8 text-center text-gray-500">No se encontraron postulantes con los filtros aplicados.</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </main>

  <!-- POPUP MODAL PARA OBSERVACIONES -->
  @if (isModalOpen) {
    <div class="fixed inset-0 z-50 flex items-center justify-center">
      <!-- Fondo oscuro -->
      <div (click)="closeWarningModal()" class="absolute inset-0 bg-black opacity-50"></div>

      <!-- Contenido del Modal -->
      <div class="relative z-10 w-full max-w-lg rounded-lg bg-white p-6 shadow-xl">
        <div class="flex items-start justify-between">
          <div>
            <h3 class="text-lg font-semibold leading-6 text-gray-900">Observaciones de Documentos</h3>
            <p class="mt-1 text-sm text-gray-500">Para el trabajador: {{ workerForModal?.nombre }}</p>
          </div>
          <button (click)="closeWarningModal()" class="text-gray-400 hover:text-gray-600">
            <lucide-icon [img]="X" class="h-6 w-6"></lucide-icon>
          </button>
        </div>

        <div class="mt-4 space-y-4">
          <!-- Sección de Documentos Vencidos -->
          @if (workerForModal?.documentosVencidos?.length > 0) {
            <div>
              <h4 class="font-medium text-red-700">Vencidos</h4>
              <ul class="mt-2 list-disc list-inside space-y-1 text-sm text-gray-600">
                @for (doc of workerForModal.documentosVencidos; track doc.id) {
                  <li>{{ doc.nombre }}</li>
                }
              </ul>
            </div>
          }

          <!-- Sección de Documentos por Vencer -->
          @if (workerForModal?.documentosPorVencer?.length > 0) {
            <div>
              <h4 class="font-medium text-yellow-700">Por Vencer (Próximos 30 días)</h4>
              <ul class="mt-2 list-disc list-inside space-y-1 text-sm text-gray-600">
                @for (doc of workerForModal.documentosPorVencer; track doc.id) {
                  <li>{{ doc.nombre }}</li>
                }
              </ul>
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>

